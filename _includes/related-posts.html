{% assign maxRelated = 3 %}
{% assign minCommonTags =  2 %}

{% assign posts_list = "" | split: "|" %}
{% assign posts_list_min = "" | split: "|" %}
{% assign posts_list_med = "" | split: "|" %}
{% assign posts_list_max = "" | split: "|" %}

{% for post in site.posts %}
  {% assign sameTagCount = 0 %}

  {% for tag in post.tags %}
    {% if post.url != page.url %}
      {% if page.tags contains tag %}
        {% assign sameTagCount = sameTagCount | plus: 1 %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if sameTagCount >= minCommonTags + 2 %}
    {% assign posts_list_max = posts_list | push: post %}
  {% elsif sameTagCount == minCommonTags + 1 %}
    {% assign posts_list_med = posts_list | push: post %}
  {% elsif sameTagCount == minCommonTags %}
    {% assign posts_list_min = posts_list | push: post %}
  {% endif %}
{% endfor %}

{% assign posts_list = posts_list_max | concat: posts_list_med | concat: posts_list_min %}

{% if posts_list.size > 0 %}
<div class="row">
    <div class="col-md-10 col-md-offset-1">
        <h3>More posts you may also enjoy</h3> 
        {% for post in posts_list | slice: 0, maxRelated %}
        <div class="col-md-3" style="padding-left: 0px;">
            <div style="padding: 0px; height: 355px; overflow: hidden; box-shadow: 0px 0.15em 0.35em 0px rgba(0,0,0,0.285);">
                <a href="{{ post.url | prepend: site.baseurl }}">
                    <span class="img" style="background-position: 50%; margin: 0px; height: 150px; display: block; background-image: url('{{ post.featured_image }}'); background-size: cover;"></span>
                    <div style="margin: 10px;">{{ post.title }}</div>
                </a>
                <div style="margin: 10px; font-size: 80%;">
                    {{ post.excerpt }}
                </div>
            </div>
        </div>
       {% endfor %}
    </div>
</div>
{% endif %}
